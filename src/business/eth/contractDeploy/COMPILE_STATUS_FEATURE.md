# 合约编译状态识别功能

## 功能概述

在未部署状态(`undeployed`)的基础上，增加对合约是否已编译的智能识别，将未部署状态细分为：
- **未编译**：合约信息不完整，缺少ABI或Bytecode
- **未部署**：合约已编译（有完整的ABI和Bytecode），但尚未部署到区块链

## 核心改进

### 1. 编译状态判断

新增判断函数 `isContractCompiled()`：
```typescript
function isContractCompiled(contract: IContract): boolean {
    return !!(contract.abi && contract.abi.trim() !== '' && 
              contract.bytecode && contract.bytecode.trim() !== '');
}
```

**判断标准**：
- ✅ 需要完整的ABI（非空且非空白字符串）
- ✅ 需要完整的Bytecode（非空且非空白字符串）
- ❌ 缺少任一项则视为未编译

### 2. 状态显示优化

#### 列表页状态显示

| 实际状态 | 显示标签 | 颜色 | 图标 |
|---------|---------|------|------|
| 未编译 | 未编译 | 橙色(warning) | CodeOutlined |
| 已编译未部署 | 未部署 | 灰色(default) | FileTextOutlined |
| 已部署 | 已部署 | 绿色(success) | CheckCircleOutlined |
| 部署中 | 部署中 | 蓝色(processing) | SyncOutlined |
| 部署失败 | 部署失败 | 红色(error) | ExclamationCircleFilled |

#### 详情页状态显示

详情页同样根据是否编译显示不同的状态标签。

### 3. 操作权限控制

#### 未编译状态

**操作按钮**：
- ✅ **编译**按钮（主按钮，蓝色）- 打开编译界面
- ✅ **详情**按钮 - 查看合约信息
- ✅ **删除**按钮 - 删除合约

**限制**：
- ❌ 不显示"部署"按钮
- ❌ 不允许直接部署操作
- ℹ️ Tooltip提示："请先编译合约才能部署"

#### 已编译未部署状态

**操作按钮**：
- ✅ **部署**按钮（主按钮，蓝色）- 打开部署界面
- ✅ **详情**按钮 - 查看合约信息
- ✅ **删除**按钮 - 删除合约

**权限**：
- ✅ 允许直接部署

### 4. 部署流程优化

#### 点击"编译"按钮（未编译状态）

```
1. 打开部署对话框
2. 加载源代码到"编写代码"标签页
3. 显示提示："此合约尚未编译，请先编译或手动输入ABI和Bytecode"
4. 用户可以选择：
   - 方式A：在"编写代码"页编译
   - 方式B：在"手动输入"页输入ABI和Bytecode
5. 编译/输入完成后点击"暂存"或"部署合约"
```

#### 点击"部署"按钮（已编译状态）

```
1. 打开部署对话框
2. 自动解析ABI和Bytecode
3. 显示构造函数参数输入框
4. 直接进入"部署配置"标签页
5. 选择账户、填写参数后点击"部署合约"
```

## 使用场景

### 场景1：只保存源代码的合约

```
状态：未编译 ⚠️
操作：点击"编译" → 编译代码 → 暂存或部署
```

### 场景2：已编译的合约

```
状态：未部署 📄
操作：点击"部署" → 选择账户 → 填写参数 → 部署
```

### 场景3：部分信息的合约

```
状态：未编译 ⚠️（只有源代码或只有ABI）
操作：点击"编译" → 补充完整信息 → 暂存或部署
```

## 视觉差异对比

### 未编译状态
```
┌─────────────────────────────────────┐
│ 合约名称: MyToken                    │
│ 状态: [⚠️ 未编译]                    │
│ 操作: [🔧 编译] [👁️ 详情] [🗑️ 删除]  │
└─────────────────────────────────────┘
```

### 已编译未部署状态
```
┌─────────────────────────────────────┐
│ 合约名称: MyToken                    │
│ 状态: [📄 未部署]                    │
│ 操作: [🚀 部署] [👁️ 详情] [🗑️ 删除]  │
└─────────────────────────────────────┘
```

## 技术实现

### 关键函数

#### 1. isContractCompiled()
判断合约是否已编译（有完整的ABI和Bytecode）

#### 2. renderStatus()
根据状态和编译情况显示不同的标签
```typescript
function renderStatus(status: string, row?: IContract) {
    if (status === 'undeployed' && row) {
        const compiled = isContractCompiled(row);
        if (!compiled) {
            return <Tag icon={<CodeOutlined />} color="warning">未编译</Tag>;
        }
        return <Tag icon={<FileTextOutlined />} color="default">未部署</Tag>;
    }
    // ... 其他状态
}
```

#### 3. renderAction()
根据编译状态显示不同的操作按钮
```typescript
function renderAction(cell: any, row: IContract) {
    if (row.status === 'undeployed') {
        const compiled = isContractCompiled(row);
        if (!compiled) {
            // 显示"编译"按钮
        } else {
            // 显示"部署"按钮
        }
    }
    // ... 其他状态
}
```

#### 4. deployUndeployedContract()
处理未部署合约的部署或编译操作
- 未编译：打开编译界面
- 已编译：打开部署界面

## 用户体验提升

### Before ❌
- 所有未部署的合约都显示相同状态
- 点击部署后才发现需要先编译
- 没有明确提示合约的完整性

### After ✅
- 清晰区分未编译和未部署状态
- 未编译状态直接显示"编译"按钮
- 橙色警告色突出未编译状态
- Tooltip提示操作限制原因

## 数据流转

```
创建合约
   ↓
[未编译状态] ⚠️
   │
   ├─→ 编译成功 → [已编译未部署状态] 📄
   │                    ↓
   │              部署成功 → [已部署状态] ✅
   │
   └─→ 直接删除 ✓
```

## 边界情况处理

### 1. 只有源代码
- 状态：未编译 ⚠️
- 操作：需要编译或手动输入ABI/Bytecode

### 2. 只有ABI
- 状态：未编译 ⚠️
- 原因：缺少Bytecode，无法部署

### 3. 只有Bytecode
- 状态：未编译 ⚠️
- 原因：缺少ABI，无法解析构造函数参数

### 4. ABI和Bytecode为空字符串
- 状态：未编译 ⚠️
- 处理：视为缺少编译信息

### 5. ABI无效（无法解析JSON）
- 状态：显示为未部署（因为有内容）
- 操作：部署时会报错提示ABI格式错误

## 测试建议

### 测试用例

1. ✅ 创建只有源代码的合约 → 验证显示"未编译"状态
2. ✅ 创建有ABI和Bytecode的合约 → 验证显示"未部署"状态
3. ✅ 点击未编译合约的"编译"按钮 → 验证打开编译界面
4. ✅ 点击已编译合约的"部署"按钮 → 验证打开部署界面
5. ✅ 尝试部署未编译合约 → 验证提示需要先编译
6. ✅ 查看详情页状态 → 验证状态显示正确

## 兼容性

- ✅ 完全向后兼容
- ✅ 已部署的合约不受影响
- ✅ 现有API不需要修改
- ✅ 只是前端显示和交互逻辑优化

## 后续优化建议

1. 添加"重新编译"功能
2. 支持在线编译（无需手动操作）
3. 添加编译状态缓存
4. 提供批量编译功能
5. 显示编译时间和编译器版本

---

**更新时间**：2025-11-08  
**版本**：v1.0  
**状态**：已完成 ✅

