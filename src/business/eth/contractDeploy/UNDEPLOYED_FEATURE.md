# 合约未部署状态（暂存）功能说明

## 功能概述

新增"未部署"状态，允许用户**在编译前或编译后**先暂存合约信息，稍后再选择合适的时机进行编译和部署。这个功能适用于以下场景：

1. **源代码暂存**：保存合约源代码，稍后编译和部署
2. **延迟部署**：编译完成后暂存，等待最佳部署时机
3. **多环境部署**：先编译并保存，然后在不同网络上部署相同的合约
4. **备份管理**：保存合约的编译结果作为备份
5. **协作开发**：团队成员可以先准备好合约，等待审核后再部署
6. **分阶段工作**：今天写代码保存，明天再编译部署

## 功能特性

### 1. 合约状态管理

现在支持四种状态：
- `undeployed` - 未部署（暂存状态）
- `deployed` - 已部署
- `pending` - 部署中
- `failed` - 部署失败

### 2. 暂存功能

在部署对话框中，增加了"暂存"按钮：
- **部署合约**：立即部署到区块链网络（需要先编译）
- **暂存**：保存合约信息，不实际部署（**无需编译**）

**暂存支持多种场景**：
1. **只保存源代码**：输入Solidity代码后直接暂存，无需编译
2. **保存编译结果**：编译后暂存，包含ABI和Bytecode
3. **手动输入ABI/Bytecode**：在"手动输入"标签页输入后暂存
4. **部分信息暂存**：可以只有源代码、只有ABI、或只有Bytecode

### 3. 延迟部署

对于未部署的合约：
- 在列表中显示"未部署"状态标签
- 操作列显示"部署"按钮，可以随时启动部署流程
- 查看详情时，地址、部署账户等字段显示为空

### 4. 统计数据

新增"未部署"统计卡片，显示当前暂存的合约数量

## 使用指南

### 暂存合约

#### 方式一：暂存源代码（最简单）

1. 点击"部署合约"按钮
2. 在"编写代码"标签页中输入或上传Solidity代码
3. **无需编译**，直接点击"暂存"按钮
4. 填写合约名称（必填）和备注（可选）
5. 合约源代码将被保存，状态为"未部署"

#### 方式二：暂存编译结果

1. 点击"部署合约"按钮
2. 在"编写代码"标签页中输入合约代码
3. 点击"编译合约"按钮
4. 编译成功后，点击"暂存"按钮（而不是"部署合约"）
5. 合约信息（源代码、ABI、Bytecode）将被保存

#### 方式三：手动输入ABI和Bytecode

1. 点击"部署合约"按钮
2. 切换到"手动输入"标签页
3. 输入合约名称、ABI、Bytecode
4. 点击"暂存"按钮
5. 合约信息将被保存

**注意**：暂存时必须填写：
- 合约名称（必填）
- 至少一项：源代码 或 ABI 或 Bytecode

不需要选择部署账户和填写构造函数参数。

### 部署暂存的合约

#### 情况一：已编译的合约（有ABI和Bytecode）

1. 在合约列表中找到状态为"未部署"的合约
2. 点击操作列的"部署"按钮
3. 系统会自动加载合约信息，打开部署对话框
4. 切换到"部署配置"标签页：
   - 选择部署账户
   - 填写构造函数参数（如果有）
   - 填写备注（可选）
5. 点击"部署合约"按钮开始部署

#### 情况二：未编译的合约（只有源代码）

1. 在合约列表中找到状态为"未部署"的合约
2. 点击操作列的"部署"按钮
3. 系统会提示"此合约尚未编译"，并自动加载源代码
4. 在"编写代码"标签页中：
   - 检查源代码
   - 点击"编译合约"按钮
5. 编译成功后，切换到"部署配置"标签页
6. 选择部署账户，填写参数
7. 点击"部署合约"按钮开始部署

### 查询未部署的合约

在查询条件中选择状态为"未部署"，即可筛选出所有暂存的合约。

## 数据库变更

### 表结构变更

1. **status字段**：增加`undeployed`枚举值
2. **address字段**：允许NULL（未部署时为空）
3. **deployer_address字段**：允许NULL
4. **deployer_account_id字段**：允许NULL
5. **network_id字段**：允许NULL
6. **network字段**：允许NULL
7. **chain_id字段**：允许NULL
8. **abi字段**：允许NULL（未编译时可为空）
9. **bytecode字段**：允许NULL（未编译时可为空）

### 迁移脚本

执行 `src/services/eth/contract_migration.sql` 脚本来更新现有数据库。

**重要提示**：
- 执行迁移前请务必备份数据库
- 确认现有的已部署合约都有address字段

## API变更

### POST /api/eth/contract

创建合约记录时：

**未部署状态**（status='undeployed'）：
- 必填字段：`name`
- 至少需要其中之一：`source_code`, `abi`, `bytecode`
- 可选字段：所有其他字段

**已部署状态**（status='deployed'）：
- 必填字段：`name`, `address`, `deployer_address`, `deployer_account_id`, `network_id`, `network`, `chain_id`, `abi`, `bytecode`
- 可选字段：`source_code`, `constructor_params`, `remark`

## TypeScript类型定义

### IContract接口变更

```typescript
export interface IContract {
    id?: number;
    name: string;
    address?: string; // 未部署时可能为空
    deployer_address?: string; // 未部署时可能为空
    deployer_account_id?: number; // 未部署时可能为空
    network_id?: number; // 未部署时可能为空
    network?: string; // 未部署时可能为空
    chain_id?: number; // 未部署时可能为空
    abi?: string; // 未编译时可能为空
    bytecode?: string; // 未编译时可能为空
    source_code?: string;
    constructor_params?: string;
    status: 'undeployed' | 'deployed' | 'pending' | 'failed';
    remark?: string;
    create_time?: string;
    update_time?: string;
}
```

## 最佳实践

1. **命名规范**：暂存合约时使用清晰的命名，便于后续识别
2. **备注信息**：添加详细的备注，说明合约用途、版本和部署注意事项
3. **定期清理**：定期检查并清理不再需要的未部署合约
4. **版本管理**：可以为同一合约的不同版本创建多个暂存记录
5. **团队协作**：利用备注字段记录合约开发者和审核状态
6. **分阶段工作**：
   - 今天写代码 → 暂存源代码
   - 明天编译 → 更新暂存记录
   - 后天部署 → 从暂存记录部署
7. **源代码备份**：即使没有编译，也可以暂存源代码作为备份

## 注意事项

1. **未部署合约无法交互**：只有已部署的合约才能进行链上交互
2. **数据完整性**：未部署合约可能缺少网络、地址等信息
3. **删除操作**：删除未部署的合约不会影响链上数据
4. **编辑限制**：暂存后如需修改合约代码，建议删除后重新创建

## 故障排查

### 问题：暂存按钮无法点击
**解决方案**：确保合约已成功编译，compiledContract状态不为空

### 问题：部署未部署的合约时提示缺少信息
**解决方案**：检查是否选择了部署账户，并填写了所有必需的构造函数参数

### 问题：未部署合约无法查看详情
**解决方案**：未部署合约可以查看详情，但某些字段（如地址）会显示为"-"或"未部署"

### 问题：数据库迁移失败
**解决方案**：
1. 检查MySQL版本是否支持所使用的语法
2. 确认是否有足够的权限执行ALTER TABLE操作
3. 检查是否存在数据约束冲突

## 更新日志

**2025-11-08 v2**
- **重大改进**：暂存功能无需编译，支持只保存源代码
- 允许abi和bytecode字段为空（未编译状态）
- 优化未编译合约的部署流程，提示用户先编译
- 改进ABI解析错误处理，提供友好的错误提示
- 更新数据库表结构，abi和bytecode可为NULL

**2025-11-08 v1**
- 新增未部署状态（undeployed）
- 添加暂存功能
- 实现未部署合约的延迟部署
- 更新统计数据，显示未部署合约数量
- 优化表单验证，区分暂存和部署两种场景
- 增强类型安全，允许相关字段为空

